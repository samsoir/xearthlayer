name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  # First: Run make verify to gate all builds
  verify:
    name: Verify
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.tag.outputs.RELEASE_TAG }}
      version: ${{ steps.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine release tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            RELEASE_TAG="${{ inputs.tag }}"
          else
            RELEASE_TAG="${{ github.ref_name }}"
          fi
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${RELEASE_TAG#v}" >> $GITHUB_OUTPUT
          echo "Release tag: ${RELEASE_TAG}"

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev

      - name: Run make verify
        run: make verify

  # Build the release binary once for reuse across Linux tarball and Debian package
  build-binary:
    name: Build Release Binary
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-binary
          path: target/release/xearthlayer

  # Package Linux binary tarball (uses pre-built binary)
  package-linux:
    name: Package Linux Binary
    runs-on: ubuntu-latest
    needs: [verify, build-binary]
    steps:
      - uses: actions/checkout@v4

      - name: Download release binary
        uses: actions/download-artifact@v4
        with:
          name: release-binary
          path: target/release

      - name: Package binary
        env:
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          chmod +x target/release/xearthlayer
          mkdir -p dist
          cp target/release/xearthlayer dist/
          cp README.md LICENSE dist/
          cd dist
          tar czvf xearthlayer-${RELEASE_TAG}-x86_64-linux.tar.gz xearthlayer README.md LICENSE

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: dist/*.tar.gz

  # Build .deb package for Debian/Ubuntu (uses pre-built binary)
  package-deb:
    name: Package Debian Package
    runs-on: ubuntu-latest
    needs: [verify, build-binary]
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Download release binary
        uses: actions/download-artifact@v4
        with:
          name: release-binary
          path: target/release

      - name: Make binary executable
        run: chmod +x target/release/xearthlayer

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build .deb package
        run: |
          cd xearthlayer-cli
          cargo deb --no-build
          mkdir -p ../dist
          cp ../target/debian/*.deb ../dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  # Build .rpm package for Fedora/RHEL/openSUSE
  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    needs: [verify]
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y rust cargo fuse3-devel rpm-build

      - name: Build release binary
        run: cargo build --release

      - name: Build RPM package
        env:
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          # Create source tarball
          mkdir -p xearthlayer-${VERSION}
          cp -r * xearthlayer-${VERSION}/ 2>/dev/null || true
          tar czvf ~/rpmbuild/SOURCES/xearthlayer-${VERSION}.tar.gz xearthlayer-${VERSION}

          # Copy spec file and update version
          cp pkg/rpm/xearthlayer.spec ~/rpmbuild/SPECS/
          sed -i "s/^Version:.*/Version:        ${VERSION}/" ~/rpmbuild/SPECS/xearthlayer.spec

          # Build RPM (binary only, skip source RPM)
          rpmbuild -bb ~/rpmbuild/SPECS/xearthlayer.spec

          mkdir -p dist
          cp ~/rpmbuild/RPMS/*/*.rpm dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: dist/*.rpm

  # Prepare AUR package files
  prepare-aur:
    name: Prepare AUR Package
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - uses: actions/checkout@v4

      - name: Generate PKGBUILD and .SRCINFO
        env:
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          mkdir -p pkg/aur

          # Download source tarball to calculate checksum
          curl -sL "https://github.com/${{ github.repository }}/archive/${RELEASE_TAG}.tar.gz" \
            -o "pkg/aur/xearthlayer-${VERSION}.tar.gz"
          SHA256=$(sha256sum "pkg/aur/xearthlayer-${VERSION}.tar.gz" | cut -d' ' -f1)

          # Generate PKGBUILD
          cat > pkg/aur/PKGBUILD << EOF
          # Maintainer: XEarthLayer Contributors
          pkgname=xearthlayer
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc='Virtual Earth imagery layer filesystem for X-Plane using FUSE'
          arch=('x86_64')
          url='https://github.com/${{ github.repository }}'
          license=('MIT')
          depends=('fuse3')
          makedepends=('rust' 'cargo')
          optdepends=('xplane12: X-Plane 12 flight simulator')
          source=("\${pkgname}-\${pkgver}.tar.gz::https://github.com/${{ github.repository }}/archive/v\${pkgver}.tar.gz")
          sha256sums=('${SHA256}')

          build() {
            cd "\${pkgname}-\${pkgver}"
            cargo build --release --locked
          }

          package() {
            cd "\${pkgname}-\${pkgver}"
            install -Dm755 "target/release/xearthlayer" "\${pkgdir}/usr/bin/xearthlayer"
            install -Dm644 "LICENSE" "\${pkgdir}/usr/share/licenses/\${pkgname}/LICENSE"
            install -Dm644 "README.md" "\${pkgdir}/usr/share/doc/\${pkgname}/README.md"
          }
          EOF

          # Generate .SRCINFO
          cat > pkg/aur/.SRCINFO << EOF
          pkgbase = xearthlayer
          	pkgdesc = Virtual Earth imagery layer filesystem for X-Plane using FUSE
          	pkgver = ${VERSION}
          	pkgrel = 1
          	url = https://github.com/${{ github.repository }}
          	arch = x86_64
          	license = MIT
          	makedepends = rust
          	makedepends = cargo
          	depends = fuse3
          	optdepends = xplane12: X-Plane 12 flight simulator
          	source = xearthlayer-\${pkgver}.tar.gz::https://github.com/${{ github.repository }}/archive/v\${pkgver}.tar.gz
          	sha256sums = ${SHA256}

          pkgname = xearthlayer
          EOF

          # Clean up tarball
          rm "pkg/aur/xearthlayer-${VERSION}.tar.gz"

      - name: Upload AUR package files
        uses: actions/upload-artifact@v4
        with:
          name: aur-package
          path: |
            pkg/aur/PKGBUILD
            pkg/aur/.SRCINFO

  # Final job: Create release and upload all assets atomically
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [verify, package-linux, package-deb, build-rpm, prepare-aur]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -ls

      - name: Generate release notes
        id: notes
        env:
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          # Extract release notes from CHANGELOG.md if available
          if [ -f CHANGELOG.md ]; then
            # Try to extract notes for this version
            NOTES=$(sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | head -n -1)
            if [ -z "$NOTES" ]; then
              NOTES=$(sed -n "/^## ${VERSION}/,/^## /p" CHANGELOG.md | head -n -1)
            fi
          fi

          if [ -z "$NOTES" ]; then
            NOTES="Release ${RELEASE_TAG}"
          fi

          # Write to file for use in release body
          echo "$NOTES" > release_notes.md

          echo "Release notes:"
          cat release_notes.md

      - name: Create draft release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          # Delete any existing release for this tag (handles manual releases or retries)
          if gh release view "${RELEASE_TAG}" &>/dev/null; then
            echo "Existing release found for ${RELEASE_TAG}, deleting..."
            gh release delete "${RELEASE_TAG}" --yes
          fi

          # Create draft release (not published yet)
          gh release create "${RELEASE_TAG}" \
            --draft \
            --title "XEarthLayer ${RELEASE_TAG}" \
            --notes-file release_notes.md

          echo "Draft release created for ${RELEASE_TAG}"

      - name: Upload Linux binary
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          gh release upload "${RELEASE_TAG}" artifacts/linux-binary/*.tar.gz

      - name: Upload Debian package
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          gh release upload "${RELEASE_TAG}" artifacts/debian-package/*.deb

      - name: Upload RPM package
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          gh release upload "${RELEASE_TAG}" artifacts/rpm-package/*.rpm

      - name: Upload AUR package files
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          # Create a zip of AUR files for easy download
          cd artifacts/aur-package
          zip -r ../../aur-package.zip .
          cd ../..
          gh release upload "${RELEASE_TAG}" aur-package.zip

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
        run: |
          # Now publish the release (make it non-draft)
          gh release edit "${RELEASE_TAG}" --draft=false

          echo "=============================================="
          echo "Release ${RELEASE_TAG} published successfully!"
          echo "=============================================="
          echo ""
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}"

      - name: Update version.json
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ needs.verify.outputs.release_tag }}
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          # Update version.json with the new release info
          RELEASE_DATE=$(date +%Y-%m-%d)

          cat > version.json << EOF
          {
            "version": "${VERSION}",
            "tag": "${RELEASE_TAG}",
            "release_date": "${RELEASE_DATE}",
            "homepage": "https://xearthlayer.app",
            "assets": {
              "deb": {
                "filename": "xearthlayer_${VERSION}-1_amd64.deb",
                "description": "Debian/Ubuntu package"
              },
              "rpm": {
                "filename": "xearthlayer-${VERSION}-1.fc43.x86_64.rpm",
                "description": "Fedora/RHEL package"
              },
              "tarball": {
                "filename": "xearthlayer-${RELEASE_TAG}-x86_64-linux.tar.gz",
                "description": "Linux binary tarball"
              },
              "aur": {
                "filename": "aur-package.zip",
                "description": "Arch Linux AUR package"
              }
            },
            "download_base_url": "https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}"
          }
          EOF

          # Commit and push version.json update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.json
          git commit -m "chore: update version.json to ${VERSION}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed - version.json may need manual update"

      - name: Notify website of new release
        env:
          WEBSITE_DISPATCH_TOKEN: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          # Trigger website sync workflow via repository_dispatch
          if [ -n "$WEBSITE_DISPATCH_TOKEN" ]; then
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${WEBSITE_DISPATCH_TOKEN}" \
              https://api.github.com/repos/samsoir/xearthlayer-website/dispatches \
              -d '{"event_type":"app-version-updated","client_payload":{"version":"'"${VERSION}"'"}}'
            echo "Website notified of new release"
          else
            echo "WEBSITE_DISPATCH_TOKEN not set - website notification skipped"
          fi

      - name: Publish to AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          VERSION: ${{ needs.verify.outputs.version }}
        run: |
          if [ -z "$AUR_SSH_PRIVATE_KEY" ]; then
            echo "=============================================="
            echo "AUR Package Ready for Manual Submission"
            echo "=============================================="
            echo ""
            echo "AUR_SSH_PRIVATE_KEY secret not configured."
            echo "The PKGBUILD and .SRCINFO files have been uploaded"
            echo "as release artifacts (aur-package.zip)."
            echo ""
            echo "To publish to AUR manually:"
            echo "  1. Download 'aur-package.zip' from the release"
            echo "  2. Clone the AUR repo:"
            echo "     git clone ssh://aur@aur.archlinux.org/xearthlayer.git"
            echo "  3. Extract and copy PKGBUILD and .SRCINFO into the repo"
            echo "  4. Commit and push:"
            echo "     git add PKGBUILD .SRCINFO"
            echo "     git commit -m 'Update to ${VERSION}'"
            echo "     git push"
            echo ""
            echo "To enable automatic AUR publishing:"
            echo "  1. Generate an SSH key: ssh-keygen -t ed25519 -f aur_key -N ''"
            echo "  2. Add public key to your AUR account"
            echo "  3. Add private key as AUR_SSH_PRIVATE_KEY secret in GitHub"
            exit 0
          fi

          echo "Publishing to AUR..."

          # Setup SSH for AUR
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key

          # Configure SSH to use the key for AUR
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur_key
            User aur
            StrictHostKeyChecking accept-new
          EOF

          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the AUR repository
          git clone ssh://aur@aur.archlinux.org/xearthlayer.git aur-repo

          # Copy the generated files
          cp artifacts/aur-package/PKGBUILD aur-repo/
          cp artifacts/aur-package/.SRCINFO aur-repo/

          # Commit and push
          cd aur-repo
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${VERSION}"
          git push

          echo "=============================================="
          echo "AUR Package Published Successfully!"
          echo "=============================================="
          echo "Package: https://aur.archlinux.org/packages/xearthlayer"

          # Cleanup
          rm -f ~/.ssh/aur_key
