# How XEarthLayer Works

This document explains the architecture of XEarthLayer and how its components work together to provide satellite imagery in X-Plane.

## The Problem

X-Plane uses scenery packages that contain:
- **DSF files** - Digital Surface Format files defining terrain mesh and object placement
- **TER files** - Terrain definition files specifying which textures to use
- **DDS files** - The actual texture images (satellite/aerial photography)

The DDS texture files are enormous - a single region can easily be 50-100+ GB. This creates problems:
- Massive download sizes
- Huge disk space requirements
- Long initial setup times

## The Solution

XEarthLayer solves this by separating the **metadata** (DSF/TER files) from the **textures** (DDS files):

```
┌─────────────────────────────────────────────────────────────────────┐
│                         X-Plane                                     │
│                                                                     │
│  Requests texture: textures/100_200_ZL16.dds                        │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    XEarthLayer FUSE Mount                           │
│                                                                     │
│  Mount Point: Custom Scenery/zzXEL_region_ortho_xel                 │
│  Source:      Custom Scenery/zzXEL_region_ortho                     │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │ Is this a DDS texture request?                               │   │
│  │                                                              │   │
│  │  NO  → Pass through to source folder (DSF, TER, etc.)        │   │
│  │  YES → Generate on-demand from satellite imagery             │   │
│  └──────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │ (DDS request)
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Tile Generation Pipeline                         │
│                                                                     │
│  1. Parse filename: 100_200_ZL16.dds → row=100, col=200, zoom=16    │
│  2. Check cache (memory → disk)                                     │
│  3. If not cached:                                                  │
│     a. Download 256 satellite image chunks (16×16 grid)             │
│     b. Composite into 4096×4096 image                               │
│     c. Encode as BC1/BC3 DDS with mipmaps                           │
│     d. Cache result                                                 │
│  4. Return DDS data to X-Plane                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## The Two Components

### 1. Regional Scenery Packages

These are small packages (megabytes, not gigabytes) containing:
- DSF files - terrain mesh and placement data
- TER files - texture references (pointing to DDS filenames)
- **No DDS files** - these are generated on-demand

The TER files reference texture filenames like `100_200_ZL16.dds`, but these files don't exist in the package. They're generated by XEarthLayer when X-Plane requests them.

### 2. XEarthLayer Streaming Service

The FUSE virtual filesystem that:
- Mounts on top of a regional scenery package
- Passes through all non-DDS files unchanged
- Intercepts DDS texture requests
- Generates textures on-demand from satellite imagery providers

## How They Work Together

**You need both components:**

1. **Install a regional scenery package** → Provides the terrain definitions (what textures go where)
2. **Run XEarthLayer streaming service** → Provides the actual texture data

Without the package, XEarthLayer has nothing to overlay - there are no DDS requests to intercept.
Without XEarthLayer, the package is incomplete - the referenced DDS files don't exist.

```
Regional Package (installed)          XEarthLayer Service (running)
┌────────────────────────┐            ┌────────────────────────┐
│ zzXEL_region_ortho/    │            │ Satellite Providers    │
│ ├── Earth nav data/    │            │ ├── Bing Maps          │
│ │   └── +40+000/       │            │ ├── Google (GO2)       │
│ │       └── +48+002.dsf│            │ └── Google Maps API    │
│ ├── terrain/           │            │                        │
│ │   └── *.ter ────────────────────────→ References textures  │
│ └── (no textures/)     │            │    that don't exist    │
└────────────────────────┘            │                        │
            │                         │ FUSE Mount intercepts  │
            │                         │ and generates them     │
            ▼                         └────────────────────────┘
┌────────────────────────┐                       │
│ zzXEL_region_ortho_xel/│ ◄──────────────────────
│ (virtual mount point)  │
│ ├── Earth nav data/    │  ← passthrough
│ ├── terrain/           │  ← passthrough
│ └── textures/          │  ← generated on-demand
│     └── 100_200_ZL16.dds
└────────────────────────┘
         │
         ▼
    X-Plane loads
    complete scenery
```

## Complete Workflow

### For End Users

1. **Configure XEarthLayer**
   ```bash
   xearthlayer init
   # Edit ~/.xearthlayer/config.ini with your library_url
   ```

2. **Install a regional package**
   ```bash
   xearthlayer packages install eu-paris
   # Installs to: Custom Scenery/zzXEL_eu-paris_ortho/
   ```

3. **Start the streaming service**
   ```bash
   xearthlayer start --source "Custom Scenery/zzXEL_eu-paris_ortho"
   # Creates mount: Custom Scenery/zzXEL_eu-paris_ortho_xel/
   ```

4. **Configure X-Plane**
   - Add the `_xel` mount point to `scenery_packs.ini`
   - The original package folder is NOT used directly

5. **Fly!**
   - X-Plane requests textures from the mount point
   - XEarthLayer generates them on-demand
   - Subsequent visits are instant (cached)

### For Content Publishers

1. **Generate tiles with Ortho4XP** (as usual)

2. **Create a package** (strips out DDS files, keeps DSF/TER)
   ```bash
   xearthlayer publish add --source ./Ortho4XP_Tiles --region eu-paris
   xearthlayer publish build --region eu-paris
   ```

3. **Distribute the package** (small, just metadata)

Users install your package and run XEarthLayer to get the textures.

## Why This Architecture?

### Advantages

| Aspect | Traditional Ortho | XEarthLayer |
|--------|-------------------|-------------|
| Package size | 50-100+ GB | 5-50 MB |
| Download time | Hours | Minutes |
| Disk usage | Full size | Cache only |
| First load | Instant | 1-2s per tile |
| Repeat visits | Instant | Instant (cached) |

### The Trade-off

- **First visit**: Slight delay as textures are downloaded and encoded
- **Requires internet**: For uncached areas (cache can be pre-warmed)
- **Service must run**: XEarthLayer needs to be running while flying

## Cache System

XEarthLayer caches generated textures to avoid re-downloading:

```
~/.cache/xearthlayer/
├── Bing Maps/
│   └── <zoom>/<row>/<col>_bc1.dds
└── Google Maps/
    └── <zoom>/<row>/<col>_bc1.dds
```

- **Memory cache**: 2 GB default, fastest access
- **Disk cache**: 20 GB default, persists between sessions

After flying an area once, it loads instantly on future visits.

## Overlay Packages

The same architecture applies to overlay packages (roads, buildings):

- Package contains placement data (no textures needed)
- Overlays render on top of the orthophoto base layer
- Package naming: `yzXEL_region_overlay` (loads before ortho)

## Summary

XEarthLayer is not "either packages or streaming" - it's **packages plus streaming**:

1. **Packages** define what goes where (terrain mesh, texture placement)
2. **Streaming** provides the actual imagery on-demand

Together, they deliver high-quality satellite scenery without massive downloads.
